# Open Data Hub - Unified Labeling Strategy

|                |                                                                 |
|----------------|-----------------------------------------------------------------|
| Date           | 2024-01-24                                                      |
| Scope          | Platform                                                        |
| Status         | Draft                                                           |
| Authors        | [Bartosz Majsak](@bartoszmajsak) [Aslak Knutsen](@aslakknutsen) |
| Supersedes     | N/A                                                             |
| Superseded by: | N/A                                                             |
| Tickets        |                                                                 |
| Other docs:    | none                                                            |

## What

This ADR proposes the adoption of a common set of Kubernetes labels and naming scheme across all components being part of Open Data Hub.

## Why

Currently, the labeling of our Kubernetes resources lacks consistency, resulting in difficulties with clear identification, managing resources effectively, and establishing policies such as network rules. 

Adopting a standard, consistent set of labels will:

- Improve clarity in ownership, role, and the lifecycle stage of resources.
- Streamline the implementation of various infrastructure components which rely on label selectors, e.g. Service Mesh or Network Policies.
- Provide a clearer view of the resource topology, helping to understand how different components interact and depend on each other within the cluster.
- Allow us to refine the scope of controllers, ensuring that they only monitor resources marked with specific labels. This targeted approach improves isolation, guaranteeing that controllers respond exclusively to changes in resources associated with the Open Data Hub. Consequently, this prevents any interference with other applications deployed within the same cluster, maintaining a clean and efficient operational environment.
- Enhance the ability to query resources and filter logs and metrics.
    
### Current challenges

#### Different Labels Addressing Similar Aspects

Knowing the origin of a namespace is crucial for resource management and grasping the context in which the namespace operates.
As of this proposal's drafting, there exist at least two labels designed to convey such metadata:

- Labels indicating a namespace generated by the Open Data Hub operator currently use: `opendatahub.io/generated-namespace: true`
- Labels indicating a namespace/data science project created by the Dashboard currently use: `opendatahub.io/dashboard: true`

This proposal advocates for standardizing these labels to introduce a coherent naming strategy.

#### Lack of a Single Repository for Labels

One significant challenge is the absence of a centralized repository or registry for managing and cataloging Kubernetes labels. 

This limitation leads to several issues:

- **Inconsistency and Duplication:** Without a single source of truth, teams may inadvertently create and use similar labels with slight variations, leading to inconsistency across the organization's Kubernetes resources.
- **Discovery and Usage Difficulty:** Developers and operators face challenges in discovering existing labels, understanding their purposes, and applying them correctly, which complicates resource management and policy enforcement.
- **Updates and Deprecation:** Managing the lifecycle of labels, including updates and deprecation, becomes cumbersome. This can result in outdated labels persisting in use, further complicating the Kubernetes environment.

To address these issues, the proposal includes the creation of a centralized label repository. This repository will serve as the definitive source for defining, accessing, and managing the lifecycle of Kubernetes labels used within the Open Data Hub. It will promote consistency, ease of use, and effective governance of labeling practices across all components.

## Goals

- Establish a clear, organization-wide standard for resource labeling.
- Create a glossary with a clear definition of the purpose and implications of each label, ensuring all team members have a common understanding and usage guidelines. This glossary will:
    - Consolidate the labels currently in use across different teams and projects to ensure there is a single source of truth.
    - Provide an easily accessible reference, minimizing the reliance on tribal knowledge and improving the overall efficiency of communication and collaboration.
    - Be regularly reviewed and updated to reflect the evolving landscape of our Kubernetes environment and the needs of our organization.
- Ensure all new resources are labeled according to the standard upon creation.
- Implement migration strategy for existing resources

## Non-Goals

- Define application-specific labels. This ADR focuses on common, organization-wide labels.
- Define unified process of applying labels. We can offer suggestions but eventually it's specific to the component implementation and how it creates dependant resources.

## How

- Review and consolidate existing labels [[1]](https://github.com/opendatahub-io/odh-dashboard/blob/b715cdd05d308d9e208b3f2b5097fe1b8f5b5586/frontend/src/k8sTypes.ts#L20-L24), [[2]](https://github.com/opendatahub-io/odh-manifests/blob/7e98dd18cc7e2a61872038dc955f710ae6bf7c14/notebook-images/base/jupyter-pytorch-notebook-imagestream.yaml#L5)
- Define Open Data Hub labels and their meaning; ensure they align with the standardized practices and provide clear attribution and context for our resources.
- Create a repository to collect 
- Plan a phased approach to update existing resources with the new label set.

### Proposed labels

#### Platform labels

These labels should be added to all relevant resources which are managed by Open Data Hub Platform and its operands. 

| Label                                          | Description                                                                 | Applied by         | Used on | Example                                                         |
|:-----------------------------------------------|:----------------------------------------------------------------------------|:-------------------|:--------|:----------------------------------------------------------------|
| `platform.opendatahub.io/component`            | Unique name of the ODH Platform Component which this resource belongs to.   | Platform/Component | *       | `platform.opendatahub.io/component: workbenches`                |               |
| `platform.opendatahub.io/data-science-cluster` | Identifies the Data Science Cluster of the resource using its unique name.  | Platform           | *       | `platform.opendatahub.io/data-science-cluster: default-dsc`     |
| `platform.opendatahub.io/data-science-project` | Marks the resource as part of a Data Science Project using its unique name. | Dashboard          | *       | `platform.opendatahub.io/data-science-project: fraud-detection` |


> [!NOTE]
> To define ownership, we prefer using `OwnerReferences` metadata over previously used (and now deprecated) labels like `app.kubernetes.io/created-by`. 
> This approach offers a more straightforward and sustainable method for tracking and managing the connections and ownership among Kubernetes objects. 
> Consistent application of this mechanism is recommended throughout the entire Open Data Hub Platform.

#### Component-specific labels

Each component uses [Kubernetes common labels](https://kubernetes.io/docs/concepts/overview/working-with-objects/common-labels/), and we recommend following subset to be present in every resource they create: 

| Label                          | Description                                                                  | Used on | Example                                                           | 
|--------------------------------|------------------------------------------------------------------------------|:--------|-------------------------------------------------------------------|
| `app.kubernetes.io/part-of`    | Name of the Open Data Hub Component that given resource is part of.          | *       | `app.kubernetes.io/part-of: "data-science-pipelines"`             | 
| `app.kubernetes.io/component`  | The component within the application architecture.                           | *       | `app.kubernetes.io/component: "database"`                         |
| `app.kubernetes.io/name`       | The name of the workload or application.                                     | *       | `app.kubernetes.io/name: "maria-db"`                              |
| `app.kubernetes.io/version`    | Currently used version of the application, can be revision, sha, semver etc. | *       | `app.kubernetes.io/name: "11.1"`                                  |
| `app.kubernetes.io/managed-by` | Unique name of the ODH workload which manages given resource.                | *       | `app.kubernetes.io/managed-by: "data-science-pipelines-operator"` |

#### Examples

```yaml
apiVersion: v1
kind: Pod
metadata:
  # ...
  labels:
    app.kubernetes.io/name: "fraud-detection"
    app.kubernetes.io/version: "2.7.0"
    app.kubernetes.io/component: "jupyter-notebooks"
    app.kubernetes.io/part-of: "workbenches"
    app.kubernetes.io/managed-by: "odh-notebook-controller"
    platform.opendatahub.io/component: "workbenches"
    platform.opendatahub.io/data-science-cluster: "acme-dsc"
    platform.opendatahub.io/data-science-project: "acme-fraud-dsp"
# ...
```

## Open Questions

- How upstream components are using recommended Kubernetes labels?
- Where should we keep reference of unique component names for ODH?
- Can `app.opendatahub.io/<component-name>: true` label be substituted by `OwnerRefence`s? 
- Shall we introduce automated policies in the cluster to prevent from using certain labels (e.g. `created-by`)?
- Should we make use of `app.kubernetes.io/part-of` to denote ODH Component mandatory?
  - Alternatively we stick to `platform.opendatahub.io/component` for this purpose and leave `app.kubernetes.io/part-of` free to use based on the component's need. This will avoid potential conflicts if upstream relies on this label for other purposes.
- Does incorporating tools into our CI/CD pipeline to ensure label compliance for newly created resources provide added value?

## Alternatives

- Continue with the current, informal labeling practices. (Not recommended due to the outlined challenges.)
- Define a completely custom set of labels specific to our organization. (Could lead to deviation from community standards and interoperability issues.)

## Security and Privacy Considerations

- Ensure that labels do not expose sensitive information

## Stakeholder Impacts

| Group    | Key Contacts      | Date        | Impacted? |
|----------|-------------------|-------------|-----------|
| [name]   | key contact name  | insert date |           |


## References

- [Kubernetes Documentation: Recommended Labels](https://kubernetes.io/docs/concepts/overview/working-with-objects/common-labels/)
- [Dashboard Labels](https://github.com/search?q=repo%3Aopendatahub-io%2Fodh-dashboard+%22opendatahub.io%2F%22&type=code&p=1) - A collection of labels used in the OpenDataHub dashboard, serving as an example of current labeling practices.

## Reviews

| Reviewed by | Date        | Notes |
|-------------|-------------|-------|
| [name]      | insert date |       |
